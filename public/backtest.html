<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #ffffff; --text: #1e293b; --accent: #3b82f6; }
        body.dark-mode { --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --accent: #60a5fa; }
        body { background-color: var(--bg); color: var(--text); transition: 0.3s; margin: 0; }
        .card { background-color: var(--card-bg); transition: 0.3s; }
        body.dark-mode input, body.dark-mode select { background-color: #334155; color: white; border-color: #475569; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-0">

    <div class="max-w-7xl mx-auto space-y-6 md:space-y-8 p-4 md:p-8">
        
        <header class="text-center mb-4 md:mb-8">
            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight" data-i18n="bt_title">DCA Calculator</h1>
            <p class="text-gray-500 mt-2 text-xs md:text-base" data-i18n="bt_desc">Calculate...</p>
        </header>

        <main class="space-y-6">
            <section class="card p-5 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h2 class="text-lg md:text-xl font-bold mb-6" data-i18n="bt_settings">Settings</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-6 mb-6">
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_coin">Symbol</label>
                        <input type="text" id="coinSymbol" value="BTC" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_amount">Amount</label>
                        <input type="number" id="investAmount" value="100" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_start">Start Date</label>
                        <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_end">End Date</label>
                        <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_freq">Frequency</label>
                        <select id="frequency" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition bg-transparent">
                            <option value="1">1 Day</option>
                            <option value="7" selected>7 Days</option>
                            <option value="30">30 Days</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 border-t border-gray-100 pt-6 dark:border-gray-700">
                    <button id="resetBtn" class="px-6 py-2.5 border border-blue-500 text-blue-600 rounded-lg hover:bg-blue-50 transition font-medium" data-i18n="bt_btn_reset">Reset</button>
                    <button id="calcBtn" class="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-lg font-medium" data-i18n="bt_btn_calc">Calculate</button>
                </div>
            </section>

            <section id="resultSection" class="hidden card p-5 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-6" data-i18n="bt_res_title">Results</h3>
                
                <div class="bg-slate-50 dark:bg-slate-800 p-4 md:p-6 rounded-xl mb-8 border border-slate-100 dark:border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4 border-b border-slate-200 dark:border-slate-600 mb-4">
                        <div>
                            <div class="text-xs opacity-60 mb-1" data-i18n="bt_total_coins">Coins</div>
                            <div class="text-xl md:text-3xl font-bold text-blue-600" id="totalCoins">0.00</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-60 mb-1" data-i18n="bt_est_profit">Profit</div>
                            <div class="text-xl md:text-3xl font-bold text-green-600" id="totalProfit">0.00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-4">
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_count">Count</div><div class="font-bold" id="totalCount">0</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_invested">Invested</div><div class="font-bold" id="totalInvested">0</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_curr_val">Value</div><div class="font-bold" id="currentValue">0.00</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_avg_price">Avg Price</div><div class="font-bold" id="avgPrice">0.00</div></div>
                    </div>
                </div>

                <div class="h-80 w-full">
                    <canvas id="dcaChart"></canvas>
                </div>
            </section>

            <section id="tableSection" class="hidden card rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 dark:bg-slate-800 dark:border-gray-700">
                    <h3 class="font-bold text-sm md:text-base" data-i18n="bt_table_title">Records</h3>
                    <button id="downloadBtn" class="text-xs md:text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 cursor-pointer transition">
                        ðŸ“¥ <span data-i18n="bt_download">Download</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs md:text-sm text-left">
                        <thead class="bg-gray-50 dark:bg-slate-700 font-medium">
                            <tr>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_date">Date</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_invest">Invest</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_price">Price</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_coins">Coins</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_total_inv">Total Inv</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_total_coins">Total Coins</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_avg">Avg Price</th>
                            </tr>
                        </thead>
                        <tbody id="recordTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                <div id="paginationContainer" class="p-4 flex justify-end space-x-2 bg-gray-50 dark:bg-slate-800 border-t border-gray-100 dark:border-gray-700"></div>
            </section>
        </main>
    </div>

    <script src="common.js"></script>
    <script>
        window.currentRecords = [];
        window.myChart = null;
        window.currentPage = 1;
        const itemsPerPage = 10;

        window.pageInit = function() {
            const today = new Date().toISOString().split('T')[0];
            const lastYear = new Date(new Date().setFullYear(new Date().getFullYear() - 1)).toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
            document.getElementById('startDate').value = lastYear;
            
            document.getElementById('calcBtn').onclick = calculateDCA;
            document.getElementById('resetBtn').onclick = resetForm;
            document.getElementById('downloadBtn').onclick = downloadCSV;
        };

        window.refreshData = function() {
            if(!document.getElementById('resultSection').classList.contains('hidden')) {
                renderResults(); 
            }
        };

        async function calculateDCA() {
            const btn = document.getElementById('calcBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Computing...';
            btn.disabled = true;

            try {
                const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
                const amount = parseFloat(document.getElementById('investAmount').value);
                const freq = parseInt(document.getElementById('frequency').value);
                const startStr = document.getElementById('startDate').value;
                const endStr = document.getElementById('endDate').value;

                const startTs = Math.floor(new Date(startStr).getTime() / 1000);
                const endTs = Math.floor(new Date(endStr).getTime() / 1000);
                
                const url = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=${coinSymbol}&tsym=USDT&limit=2000&toTs=${endTs}`;
                const res = await fetch(url);
                const json = await res.json();
                if (json.Response === 'Error') throw new Error(json.Message);

                const prices = json.Data.Data;
                const relevantData = prices.filter(p => p.time >= startTs);
                if (relevantData.length === 0) throw new Error("No Data");

                window.currentRecords = [];
                let totalInvestedUSD = 0;
                let totalCoins = 0;
                let nextBuyTs = startTs;

                for (let day of relevantData) {
                    if (day.time >= nextBuyTs) {
                        if(day.close > 0) {
                            const coins = amount / day.close;
                            totalCoins += coins;
                            totalInvestedUSD += amount;
                            
                            window.currentRecords.push({
                                date: new Date(day.time * 1000).toLocaleDateString(),
                                invest: amount,
                                price: day.close,
                                coins: coins,
                                totalInv: totalInvestedUSD,
                                totalCoins: totalCoins,
                                avgPrice: totalInvestedUSD / totalCoins,
                                ts: day.time
                            });
                        }
                        nextBuyTs += freq * 86400;
                    }
                }
                renderResults();

            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderResults() {
            if(window.currentRecords.length === 0) return;
            const last = window.currentRecords[window.currentRecords.length-1];
            const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
            
            const finalValueUSD = last.totalCoins * last.price;
            const profitUSD = finalValueUSD - last.totalInv;

            document.getElementById('totalCoins').innerText = last.totalCoins.toFixed(4) + " " + coinSymbol;
            document.getElementById('totalCount').innerText = window.currentRecords.length;
            document.getElementById('totalInvested').innerText = formatMoney(last.totalInv);
            document.getElementById('currentValue').innerText = formatMoney(finalValueUSD);
            document.getElementById('totalProfit').innerText = formatMoney(profitUSD);
            document.getElementById('totalProfit').className = profitUSD >= 0 ? "text-xl md:text-3xl font-bold text-green-600" : "text-xl md:text-3xl font-bold text-red-600";
            document.getElementById('avgPrice').innerText = formatMoney(last.avgPrice);

            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');

            renderChart();
            window.currentPage = 1;
            renderTable();
        }

        function renderChart() {
            const ctx = document.getElementById('dcaChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            
            // æ ¸å¿ƒä¿®å¤ï¼šèŽ·å–å½“å‰è´§å¸ç¬¦å·å’Œç¿»è¯‘åŽçš„ Label
            const curr = localStorage.getItem('currency') || 'USD';
            const t = (k) => window.getTrans ? window.getTrans(k) : k;

            const labels = window.currentRecords.map(r => r.date);
            const mktPrices = window.currentRecords.map(r => r.price);
            const avgPrices = window.currentRecords.map(r => r.avgPrice);
            const quantities = window.currentRecords.map(r => r.coins);

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: t('chart_qty'), // "ç´¯è®¡æŒä»“æ•°é‡"
                            data: quantities, 
                            type: 'bar', 
                            backgroundColor: 'rgba(59, 130, 246, 0.5)', 
                            yAxisID: 'y1', 
                            order: 2 
                        },
                        { 
                            label: t('chart_avg') + ` (${curr})`, // "æŒä»“å‡ä»· (CNY)"
                            data: avgPrices, 
                            borderColor: '#3b82f6', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                            fill: true, tension: 0.4, pointRadius: 0, yAxisID: 'y', order: 1 
                        },
                        { 
                            label: t('chart_mkt') + ` (${curr})`, // "å¸‚åœºä»·æ ¼ (CNY)"
                            data: mktPrices, 
                            borderColor: '#f59e0b', 
                            borderDash: [5, 5], 
                            pointRadius: 0, tension: 0.4, yAxisID: 'y', order: 0 
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    // æ ¸å¿ƒä¿®å¤ï¼šTooltip ä½¿ç”¨ formatMoney è‡ªåŠ¨å¸¦ä¸Š Â¥ æˆ– $
                                    if (context.dataset.yAxisID === 'y1') {
                                        return label + context.parsed.y;
                                    } else {
                                        return label + formatMoney(context.parsed.y);
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { position: 'right', grid: { color: document.body.classList.contains('dark-mode') ? '#334155' : '#f1f5f9' } },
                        y1: { position: 'left', display: true, grid: { display: false } }
                    }
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('recordTableBody');
            tbody.innerHTML = '';
            const reversed = [...window.currentRecords].reverse();
            const start = (window.currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            
            reversed.slice(start, end).forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3">${r.date}</td>
                    <td class="px-4 py-3">${formatMoney(r.invest)}</td>
                    <td class="px-4 py-3">${formatMoney(r.price)}</td>
                    <td class="px-4 py-3">${r.coins.toFixed(6)}</td>
                    <td class="px-4 py-3">${formatMoney(r.totalInv)}</td>
                    <td class="px-4 py-3">${r.totalCoins.toFixed(4)}</td>
                    <td class="px-4 py-3 text-blue-600 font-medium">${formatMoney(r.avgPrice)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            const totalPages = Math.ceil(reversed.length / itemsPerPage);
            const container = document.getElementById('paginationContainer');
            container.innerHTML = `
                <button ${window.currentPage===1?'disabled':''} onclick="window.currentPage--;renderTable()" class="px-3 py-1 bg-white dark:bg-slate-700 border rounded disabled:opacity-50"><</button>
                <span class="px-3 py-1 text-sm">Page ${window.currentPage} / ${totalPages}</span>
                <button ${window.currentPage===totalPages?'disabled':''} onclick="window.currentPage++;renderTable()" class="px-3 py-1 bg-white dark:bg-slate-700 border rounded disabled:opacity-50">></button>
            `;
        }

        function downloadCSV() {
            if (window.currentRecords.length === 0) return;
            const symbol = document.getElementById('coinSymbol').value;
            let csv = "Date,Invest,Price,Coins,TotalInv,TotalCoins,AvgPrice\n";
            window.currentRecords.forEach(r => {
                csv += `${r.date},${r.invest},${r.price},${r.coins},${r.totalInv},${r.totalCoins},${r.avgPrice}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = `DCA_${symbol}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetForm() {
            document.getElementById('coinSymbol').value = "BTC";
            document.getElementById('investAmount').value = "100";
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('tableSection').classList.add('hidden');
        }
    </script>
</body>
</html>
