<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®šæŠ•æ—¶å…‰æœº - Backtest</title>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #fff; --text: #333; --accent: #6c5ce7; --green: #00b894; --red: #d63031; }
        body.dark-mode { --bg: #121212; --card-bg: #1e1e1e; --text: #f0f0f0; --accent: #a29bfe; --green: #55efc4; --red: #ff7675; }
        
        body { font-family: sans-serif; padding: 20px; max-width: 640px; margin: 0 auto; background: var(--bg); color: var(--text); transition: 0.3s; }
        .nav { margin-bottom: 20px; display: flex; gap: 15px; }
        .nav a { text-decoration: none; color: var(--text); opacity: 0.6; font-weight: bold; }
        .nav a.active { opacity: 1; color: var(--accent); border-bottom: 2px solid var(--accent); }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; opacity: 0.8; }
        input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: var(--bg); color: var(--text); font-size: 16px; box-sizing: border-box;}
        
        .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .result-box { display: none; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px; }
        .big-num { font-size: 32px; font-weight: 800; margin: 10px 0; }
        .profit-plus { color: var(--green); }
        .profit-minus { color: var(--red); }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
    </style>
</head>
<body>

    <div class="nav">
        <a href="index.html">ğŸ  è¡Œæƒ…çœ‹æ¿</a>
        <a href="backtest.html" class="active">ğŸ“‰ æ—¶å…‰æœº</a>
        <a href="#" style="cursor:not-allowed; opacity:0.3">ğŸ“’ è®°è´¦(å¼€å‘ä¸­)</a>
    </div>

    <div class="card">
        <h2>â³ å¦‚æœæˆ‘ä»¥å‰å°±å¼€å§‹...</h2>
        
        <div class="input-group">
            <label>å®šæŠ•é¢‘ç‡</label>
            <select id="freq">
                <option value="daily">æ¯å¤©å®šæŠ• (Daily)</option>
                <option value="weekly" selected>æ¯å‘¨å®šæŠ• (Weekly)</option>
                <option value="monthly">æ¯æœˆå®šæŠ• (Monthly)</option>
            </select>
        </div>

        <div class="input-group">
            <label>æ¯æ¬¡æŠ•å…¥é‡‘é¢ (USDT)</label>
            <input type="number" id="amount" value="100">
        </div>

        <div class="input-group">
            <label>å¼€å§‹æ—¶é—´ (å›æµ‹èŒƒå›´: æœ€å¤š365å¤©)</label>
            <select id="days-ago">
                <option value="30">æœ€è¿‘ 1 ä¸ªæœˆ</option>
                <option value="90">æœ€è¿‘ 3 ä¸ªæœˆ</option>
                <option value="180">æœ€è¿‘ 6 ä¸ªæœˆ</option>
                <option value="365" selected>æœ€è¿‘ 1 å¹´</option>
            </select>
        </div>

        <button class="btn" onclick="runBacktest()" id="run-btn">å¼€å§‹è®¡ç®—</button>

        <div id="result" class="result-box">
            <div class="row">
                <span>æ€»æŠ•å…¥æœ¬é‡‘:</span>
                <span id="total-invested">--</span>
            </div>
            <div class="row">
                <span>å½“å‰èµ„äº§ä»·å€¼:</span>
                <span id="current-value" style="font-weight:bold">--</span>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <label>æ€»æ”¶ç›Šç‡</label>
                <div id="roi" class="big-num">0.00%</div>
                <div id="profit-amt" style="font-size: 14px;">+ $0</div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        async function runBacktest() {
            const btn = document.getElementById('run-btn');
            const resultBox = document.getElementById('result');
            
            // 1. è·å–ç”¨æˆ·è¾“å…¥
            const amount = parseFloat(document.getElementById('amount').value);
            const freq = document.getElementById('freq').value;
            const days = parseInt(document.getElementById('days-ago').value);
            
            // UI äº¤äº’
            btn.innerText = "æ­£åœ¨ç©¿è¶Šæ—¶ç©º...";
            btn.disabled = true;
            resultBox.style.display = 'none';

            try {
                // 2. å€Ÿç”¨ä¹‹å‰çš„ API è·å–å†å²æ•°æ® (å¤ç”¨ get-ahr999 é‡Œçš„ Coingecko æ•°æ®æº)
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥è¯·æ±‚ Coingecko å‰ç«¯æ¥å£ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å†™ä¸ªæ–° APIï¼Œä½†ä¸ºäº†çœäº‹ç›´æ¥å‰ç«¯è¯·æ±‚
                const res = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${days}&interval=daily`);
                const data = await res.json();
                const prices = data.prices; // [[timestamp, price], ...]

                let totalInvested = 0;
                let totalCoins = 0;
                let lastInvestTime = 0;
                
                // 3. å¼€å§‹æ¨¡æ‹Ÿå®šæŠ•
                // é—´éš”æ—¶é—´(æ¯«ç§’): å¤©=86400000, å‘¨=604800000, æœˆ=2592000000
                let interval = 86400000; 
                if(freq === 'weekly') interval = 604800000;
                if(freq === 'monthly') interval = 2592000000;

                // éå†æ¯ä¸€å¤©çš„å†å²ä»·æ ¼
                for (let i = 0; i < prices.length; i++) {
                    const timestamp = prices[i][0];
                    const price = prices[i][1];

                    // å¦‚æœå½“å‰æ—¶é—´ > ä¸Šæ¬¡å®šæŠ•æ—¶é—´ + é—´éš”ï¼Œå°±ä¹°å…¥
                    if (timestamp > lastInvestTime + interval) {
                        const coinsBought = amount / price; // ä¹°äº†å¤šå°‘å¸
                        totalCoins += coinsBought;
                        totalInvested += amount;
                        lastInvestTime = timestamp;
                    }
                }

                // 4. è®¡ç®—æœ€ç»ˆç»“æœ
                const currentPrice = prices[prices.length - 1][1];
                const finalValue = totalCoins * currentPrice;
                const profit = finalValue - totalInvested;
                const roi = (profit / totalInvested) * 100;

                // 5. æ˜¾ç¤ºç»“æœ
                document.getElementById('total-invested').innerText = '$' + totalInvested.toLocaleString();
                document.getElementById('current-value').innerText = '$' + finalValue.toLocaleString(undefined, {maximumFractionDigits: 2});
                
                const roiEl = document.getElementById('roi');
                const profitEl = document.getElementById('profit-amt');
                
                roiEl.innerText = (roi > 0 ? '+' : '') + roi.toFixed(2) + '%';
                profitEl.innerText = (profit > 0 ? '+' : '') + '$' + profit.toLocaleString(undefined, {maximumFractionDigits: 2});

                if(profit >= 0) {
                    roiEl.className = 'big-num profit-plus';
                    profitEl.className = 'profit-plus';
                } else {
                    roiEl.className = 'big-num profit-minus';
                    profitEl.className = 'profit-minus';
                }

                resultBox.style.display = 'block';

            } catch (err) {
                alert("æ•°æ®è·å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¯·æ±‚å¤ªé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚");
                console.error(err);
            } finally {
                btn.innerText = "å¼€å§‹è®¡ç®—";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
