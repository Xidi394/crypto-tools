<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #ffffff; --text: #1e293b; --accent: #3b82f6; }
        body.dark-mode { --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --accent: #60a5fa; }
        body { background-color: var(--bg); color: var(--text); transition: 0.3s; margin: 0; }
        .card { background-color: var(--card-bg); transition: 0.3s; }
        body.dark-mode input, body.dark-mode select { background-color: #334155; color: white; border-color: #475569; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-0">

    <div class="max-w-7xl mx-auto space-y-6 md:space-y-8 p-4 md:p-8">
        
        <header class="text-center mb-4 md:mb-8">
            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight" data-i18n="bt_title">åŠ å¯†è´§å¸å®šæŠ•æ”¶ç›Šè®¡ç®—å™¨</h1>
            <p class="text-gray-500 mt-2 text-xs md:text-base" data-i18n="bt_desc">åŸºäºçœŸå®å†å²æ•°æ®å›æµ‹...</p>
        </header>

        <main class="space-y-6">
            <section class="card p-5 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg md:text-xl font-bold" data-i18n="bt_settings">å›æµ‹å‚æ•°è®¾ç½®</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-6 mb-6">
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_coin">å®šæŠ•å¸ç§</label>
                        <input type="text" id="coinSymbol" value="BTC" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_amount">å®šæŠ•é‡‘é¢ (USDT)</label>
                        <input type="number" id="investAmount" value="100" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_start">å¼€å§‹æ—¶é—´</label>
                        <input type="date" id="startDate" min="2009-01-01" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_end">ç»“æŸæ—¶é—´</label>
                        <input type="date" id="endDate" min="2009-01-01" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70" data-i18n="bt_freq">å®šæŠ•é¢‘ç‡</label>
                        <select id="frequency" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition bg-transparent">
                            <option value="1">æ¯å¤© (Daily)</option>
                            <option value="7" selected>æ¯7å¤© (Weekly)</option>
                            <option value="30">æ¯30å¤© (Monthly)</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 border-t border-gray-100 pt-6 dark:border-gray-700">
                    <button onclick="resetForm()" class="px-6 py-2.5 border border-blue-500 text-blue-600 rounded-lg hover:bg-blue-50 transition font-medium" data-i18n="bt_btn_reset">ä¸€é”®é‡ç½®</button>
                    <button id="calcBtn" onclick="calculateDCA()" class="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-lg font-medium" data-i18n="bt_btn_calc">
                        ç«‹å³å›æµ‹ç»“æœ
                    </button>
                </div>
            </section>

            <section id="resultSection" class="hidden card p-5 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold mb-6" data-i18n="bt_res_title">å›æµ‹ç»“æœåˆ†æ</h3>
                
                <div class="bg-slate-50 dark:bg-slate-800 p-4 md:p-6 rounded-xl mb-8 border border-slate-100 dark:border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4 border-b border-slate-200 dark:border-slate-600 mb-4">
                        <div>
                            <div class="text-xs opacity-60 mb-1" data-i18n="bt_total_coins">ç´¯è®¡æŒä»“</div>
                            <div class="text-xl md:text-3xl font-bold text-blue-600" id="totalCoins">0.00</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-60 mb-1" data-i18n="bt_est_profit">é¢„ä¼°æ”¶ç›Š</div>
                            <div class="text-xl md:text-3xl font-bold text-green-600" id="totalProfit">0.00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-4">
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_count">å®šæŠ•æ¬¡æ•°</div><div class="font-bold" id="totalCount">0</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_invested">æŠ•å…¥æœ¬é‡‘</div><div class="font-bold" id="totalInvested">0</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_curr_val">å½“å‰ä»·å€¼</div><div class="font-bold" id="currentValue">0.00</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_avg_price">æŒä»“å‡ä»·</div><div class="font-bold" id="avgPrice">0.00</div></div>
                    </div>
                </div>

                <div class="h-80 w-full">
                    <canvas id="dcaChart"></canvas>
                </div>
            </section>

            <section id="tableSection" class="hidden card rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 dark:bg-slate-800 dark:border-gray-700">
                    <h3 class="font-bold text-sm md:text-base" data-i18n="bt_table_title">è¯¦ç»†å®šæŠ•è®°å½•</h3>
                    <button onclick="downloadCSV()" class="text-xs md:text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 cursor-pointer transition">
                        ğŸ“¥ <span data-i18n="bt_download">ä¸‹è½½è®°å½•</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs md:text-sm text-left">
                        <thead class="bg-gray-50 dark:bg-slate-700 font-medium">
                            <tr>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_date">æ—¥æœŸ</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_invest">æœ¬æœŸæŠ•å…¥</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_price">æˆäº¤ä»·</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_coins">è·å¾—æ•°é‡</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_total_inv">ç´¯è®¡æŠ•å…¥</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_total_coins">ç´¯è®¡æŒä»“</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_avg">æŒä»“å‡ä»·</th>
                            </tr>
                        </thead>
                        <tbody id="recordTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                <div id="paginationContainer" class="p-4 flex justify-end space-x-2 bg-gray-50 dark:bg-slate-800 border-t border-gray-100 dark:border-gray-700"></div>
            </section>
        </main>
    </div>

    <script src="common.js"></script>
    <script>
        let currentRecords = [];
        let myChart = null;
        let currentPage = 1;
        const itemsPerPage = 10;

        window.pageInit = function() {
            const today = new Date().toISOString().split('T')[0];
            const lastYear = new Date(new Date().setFullYear(new Date().getFullYear() - 1)).toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
            document.getElementById('startDate').value = lastYear;
        };

        window.refreshData = function() {
            if(!document.getElementById('resultSection').classList.contains('hidden')) {
                // å¦‚æœå·²ç»æœ‰æ•°æ®ï¼Œåˆ‡æ¢è¯­è¨€æ—¶éœ€è¦é‡æ–°æ¸²æŸ“å›¾è¡¨å’Œè¡¨æ ¼ä»¥æ›´æ–°æ–‡å­—
                renderResults(); 
            }
        };

        async function calculateDCA() {
            const btn = document.getElementById('calcBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Computing...';
            btn.disabled = true;

            try {
                const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
                const amount = parseFloat(document.getElementById('investAmount').value);
                const freq = parseInt(document.getElementById('frequency').value);
                const startStr = document.getElementById('startDate').value;
                const endStr = document.getElementById('endDate').value;

                const startTs = Math.floor(new Date(startStr).getTime() / 1000);
                const endTs = Math.floor(new Date(endStr).getTime() / 1000);
                
                const url = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=${coinSymbol}&tsym=USDT&limit=2000&toTs=${endTs}`;
                const res = await fetch(url);
                const json = await res.json();
                if (json.Response === 'Error') throw new Error(json.Message);

                const prices = json.Data.Data;
                const relevantData = prices.filter(p => p.time >= startTs);
                if (relevantData.length === 0) throw new Error("æ‰€é€‰æ—¶é—´æ®µæ— æ•°æ®");

                // è®¡ç®—é€»è¾‘
                currentRecords = [];
                let totalInvestedUSD = 0;
                let totalCoins = 0;
                let nextBuyTs = startTs;

                for (let day of relevantData) {
                    if (day.time >= nextBuyTs) {
                        if(day.close > 0) {
                            const coins = amount / day.close;
                            totalCoins += coins;
                            totalInvestedUSD += amount;
                            
                            // è®°å½•æ¯ä¸€ç¬”ï¼ˆç”¨äºè¡¨æ ¼ï¼‰
                            currentRecords.push({
                                date: new Date(day.time * 1000).toLocaleDateString(),
                                invest: amount,
                                price: day.close,
                                coins: coins,
                                totalInv: totalInvestedUSD,
                                totalCoins: totalCoins,
                                avgPrice: totalInvestedUSD / totalCoins,
                                // å›¾è¡¨æ•°æ®
                                ts: day.time
                            });
                        }
                        nextBuyTs += freq * 86400;
                    }
                    // è¡¥å……æ¯æ—¥å¸‚åœºä»·æ ¼ç”¨äºç”»å›¾ï¼ˆå³ä½¿æ²¡ä¹°å…¥çš„é‚£å¤©ï¼‰
                    // ç®€åŒ–å¤„ç†ï¼šè¿™é‡Œæˆ‘ä»¬åªåœ¨è®°å½•é‡Œå­˜äº†ä¹°å…¥ç‚¹ï¼Œç”»å›¾ä¹Ÿç”»ä¹°å…¥ç‚¹
                }

                // æ¸²æŸ“æ‰€æœ‰ç»“æœ
                renderResults();

            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderResults() {
            if(currentRecords.length === 0) return;
            
            const last = currentRecords[currentRecords.length-1];
            const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
            const currentPrice = last.price; // è¿‘ä¼¼å–æœ€åä¸€æ¬¡å®šæŠ•æ—¶çš„ä»·æ ¼
            const finalValueUSD = last.totalCoins * currentPrice;
            const profitUSD = finalValueUSD - last.totalInv;

            // 1. é¡¶éƒ¨æ•°æ®å¡ç‰‡
            document.getElementById('totalCoins').innerText = last.totalCoins.toFixed(4) + " " + coinSymbol;
            document.getElementById('totalCount').innerText = currentRecords.length;
            document.getElementById('totalInvested').innerText = formatMoney(last.totalInv);
            document.getElementById('currentValue').innerText = formatMoney(finalValueUSD);
            document.getElementById('totalProfit').innerText = formatMoney(profitUSD);
            document.getElementById('totalProfit').className = profitUSD >= 0 ? "text-xl md:text-3xl font-bold text-green-600" : "text-xl md:text-3xl font-bold text-red-600";
            document.getElementById('avgPrice').innerText = formatMoney(last.avgPrice);

            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');

            // 2. ç”»å›¾
            renderChart();
            
            // 3. è¡¨æ ¼åˆ†é¡µ
            currentPage = 1;
            renderTable();
        }

        function renderChart() {
            const ctx = document.getElementById('dcaChart').getContext('2d');
            if (myChart) myChart.destroy();

            const labels = currentRecords.map(r => r.date);
            // å¸‚åœºä»·æ ¼ (ç”¨çº¢è‰²è™šçº¿)
            const marketPrices = currentRecords.map(r => r.price);
            // å®šæŠ•å‡ä»· (ç”¨è“è‰²çº¿)
            const avgPrices = currentRecords.map(r => r.avgPrice);
            // å®šæŠ•æ•°é‡ (ç”¨æŸ±çŠ¶å›¾ï¼Œåœ¨å·¦è½´)
            const quantities = currentRecords.map(r => r.coins);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: getTrans('bt_chart_qty'), // å®šæŠ•æ•°é‡
                            data: quantities,
                            type: 'bar',
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            yAxisID: 'y1', // å·¦è½´
                            order: 2
                        },
                        {
                            label: getTrans('bt_chart_avg'), // å‡ä»·
                            data: avgPrices,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            yAxisID: 'y', // å³è½´
                            order: 1
                        },
                        {
                            label: getTrans('bt_chart_mkt'), // å¸‚åœºä»·
                            data: marketPrices,
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.4,
                            yAxisID: 'y', // å³è½´
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: { display: false },
                        y: { 
                            [cite_start]position: 'right', // ä»·æ ¼åœ¨å³è¾¹ [cite: 212]
                            grid: { color: document.body.classList.contains('dark-mode') ? '#334155' : '#f1f5f9' }
                        },
                        y1: {
                            [cite_start]position: 'left', // æ•°é‡åœ¨å·¦è¾¹ [cite: 214]
                            grid: { display: false },
                            display: true
                        }
                    }
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('recordTableBody');
            tbody.innerHTML = '';
            
            // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            const reversed = [...currentRecords].reverse();
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = reversed.slice(start, end);

            pageData.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3">${r.date}</td>
                    <td class="px-4 py-3">${formatMoney(r.invest)}</td>
                    <td class="px-4 py-3">${formatMoney(r.price)}</td>
                    <td class="px-4 py-3">${r.coins.toFixed(6)}</td>
                    <td class="px-4 py-3">${formatMoney(r.totalInv)}</td>
                    <td class="px-4 py-3">${r.totalCoins.toFixed(4)}</td>
                    <td class="px-4 py-3 text-blue-600 font-medium">${formatMoney(r.avgPrice)}</td>
                `;
                tbody.appendChild(tr);
            });

            // ç®€å•åˆ†é¡µé€»è¾‘
            const totalPages = Math.ceil(reversed.length / itemsPerPage);
            const container = document.getElementById('paginationContainer');
            container.innerHTML = `
                <button ${currentPage===1?'disabled':''} onclick="currentPage--;renderTable()" class="px-3 py-1 bg-white dark:bg-slate-700 border rounded disabled:opacity-50"><</button>
                <span class="px-3 py-1 text-sm">Page ${currentPage} / ${totalPages}</span>
                <button ${currentPage===totalPages?'disabled':''} onclick="currentPage++;renderTable()" class="px-3 py-1 bg-white dark:bg-slate-700 border rounded disabled:opacity-50">></button>
            `;
        }

        function downloadCSV() {
            if (currentRecords.length === 0) return;
            const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
            
            // CSVå¤´
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Date,Invested(USD),Price(USD),Coins,Total Invested(USD),Total Coins,Avg Price(USD)\n`;
            
            currentRecords.forEach(r => {
                csvContent += `${r.date},${r.invest},${r.price},${r.coins},${r.totalInv},${r.totalCoins},${r.avgPrice}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `DCA_${coinSymbol}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetForm() {
            document.getElementById('coinSymbol').value = "BTC";
            document.getElementById('investAmount').value = "100";
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('tableSection').classList.add('hidden');
        }
    </script>
</body>
</html>
