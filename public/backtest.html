<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #ffffff; --text: #1e293b; --accent: #3b82f6; }
        body.dark-mode { --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --accent: #60a5fa; }
        
        body { background-color: var(--bg); color: var(--text); transition: 0.3s; margin: 0; }
        .card { background-color: var(--card-bg); transition: 0.3s; }
        
        /* ËæìÂÖ•Ê°ÜÊ†∑ÂºèÈÄÇÈÖç */
        body.dark-mode input, body.dark-mode select { background-color: #334155; color: white; border-color: #475569; }
        
        /* Âä†ËΩΩÂä®Áîª */
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Êñ∞Â¢ûÔºöËÅîÊÉ≥‰∏ãÊãâËèúÂçïÊ†∑Âºè (ÂÆåÂÖ®ÂèÇËÄÉ dtsyjsq.txt) --- */
        .custom-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            max-height: 300px; overflow-y: auto; z-index: 50; display: none;
        }
        body.dark-mode .custom-dropdown { background: #1e293b; border-color: #475569; }
        
        .dropdown-item {
            display: flex; align-items: center; padding: 10px 12px;
            cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f3f4f6;
        }
        body.dark-mode .dropdown-item { border-color: #334155; }
        body.dark-mode .dropdown-item:hover { background-color: #334155; }
        .dropdown-item:hover { background-color: #f1f5f9; }
        .dropdown-item:last-child { border-bottom: none; }
        
        .coin-icon { width: 28px; height: 28px; margin-right: 12px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .avatar-fallback { width: 28px; height: 28px; margin-right: 12px; border-radius: 50%; background-color: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0; }
    </style>
</head>
<body class="p-0">

    <div class="max-w-7xl mx-auto space-y-6 md:space-y-8 p-4 md:p-8">
        
        <header class="text-center mb-4 md:mb-8">
            <h1 class="text-2xl md:text-4xl font-extrabold tracking-tight" data-i18n="bt_title">DCA Calculator</h1>
            <p class="text-gray-500 mt-2 text-xs md:text-base" data-i18n="bt_desc">Calculate...</p>
        </header>

        <main class="space-y-6">
            <section class="card p-5 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg md:text-xl font-bold" data-i18n="bt_settings">Settings</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-6 mb-6">
                    <div class="flex flex-col space-y-1 relative">
                        <label class="text-sm font-medium opacity-70"><span data-i18n="bt_coin">Symbol</span> <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="coinSymbol" value="" autocomplete="off"
                                   class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase transition" 
                                   placeholder="BTC, ETH...">
                            <div id="coinDropdown" class="custom-dropdown"></div>
                        </div>
                        <div id="err-coin" class="text-red-500 text-xs hidden">Please select a coin</div>
                    </div>

                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70"><span data-i18n="bt_amount">Amount</span> <span class="text-red-500">*</span></label>
                        <input type="number" id="investAmount" value="100" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <div id="err-amount" class="text-red-500 text-xs hidden">Please enter amount</div>
                    </div>

                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70"><span data-i18n="bt_start">Start Date</span> <span class="text-red-500">*</span></label>
                        <input type="date" id="startDate" min="2009-01-01" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <div id="err-start" class="text-red-500 text-xs hidden">Please select start date</div>
                    </div>

                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70"><span data-i18n="bt_end">End Date</span> <span class="text-red-500">*</span></label>
                        <input type="date" id="endDate" min="2009-01-01" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition">
                        <div id="err-end" class="text-red-500 text-xs hidden">Please select end date</div>
                    </div>

                    <div class="flex flex-col space-y-1">
                        <label class="text-sm font-medium opacity-70"><span data-i18n="bt_freq">Frequency</span> <span class="text-red-500">*</span></label>
                        <select id="frequency" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition bg-transparent">
                            <option value="1">1 Day (ÊØèÂ§©)</option>
                            <option value="7" selected>7 Days (ÊØèÂë®)</option>
                            <option value="30">30 Days (ÊØèÊúà)</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-center space-x-4 border-t border-gray-100 pt-6 dark:border-gray-700">
                    <button id="resetBtn" class="px-6 py-2.5 border border-blue-500 text-blue-600 rounded-lg hover:bg-blue-50 transition font-medium" data-i18n="bt_btn_reset">Reset</button>
                    <button id="calcBtn" class="px-8 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-lg font-medium" data-i18n="bt_btn_calc">Calculate</button>
                </div>
            </section>

            <section id="resultSection" class="hidden card p-5 md:p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <div id="dateFixMsg" class="hidden mb-4 p-3 bg-blue-50 text-blue-700 text-sm rounded border border-blue-200 flex items-center dark:bg-blue-900 dark:text-blue-200 dark:border-blue-800">
                    <span id="dateFixText"></span>
                </div>

                <h3 class="text-lg font-bold mb-6" data-i18n="bt_res_title">Results</h3>
                
                <div class="bg-slate-50 dark:bg-slate-800 p-4 md:p-6 rounded-xl mb-8 border border-slate-100 dark:border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4 border-b border-slate-200 dark:border-slate-600 mb-4">
                        <div>
                            <div class="text-xs opacity-60 mb-1" data-i18n="bt_total_coins">Coins</div>
                            <div class="text-xl md:text-3xl font-bold text-blue-600" id="totalCoins">0.00</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-60 mb-1" data-i18n="bt_est_profit">Profit</div>
                            <div class="text-xl md:text-3xl font-bold text-green-600" id="totalProfit">0.00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-y-6 gap-x-4">
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_count">Count</div><div class="font-bold" id="totalCount">0</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_invested">Invested</div><div class="font-bold" id="totalInvested">0</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_curr_val">Value</div><div class="font-bold" id="currentValue">0.00</div></div>
                        <div><div class="text-xs opacity-60 mb-1" data-i18n="bt_avg_price">Avg Price</div><div class="font-bold" id="avgPrice">0.00</div></div>
                    </div>
                </div>

                <div class="h-80 w-full">
                    <canvas id="dcaChart"></canvas>
                </div>
            </section>

            <section id="tableSection" class="hidden card rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 dark:bg-slate-800 dark:border-gray-700">
                    <h3 class="font-bold text-sm md:text-base" data-i18n="bt_table_title">Records</h3>
                    <button id="downloadBtn" class="text-xs md:text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 cursor-pointer transition">
                        üì• <span data-i18n="bt_download">Download</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs md:text-sm text-left">
                        <thead class="bg-gray-50 dark:bg-slate-700 font-medium">
                            <tr>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_date">Date</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_invest">Invest</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_price">Price</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_coins">Coins</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_total_inv">Total Inv</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_total_coins">Total Coins</th>
                                <th class="px-4 py-3 whitespace-nowrap" data-i18n="th_avg">Avg Price</th>
                            </tr>
                        </thead>
                        <tbody id="recordTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                <div id="paginationContainer" class="p-4 flex justify-end space-x-2 bg-gray-50 dark:bg-slate-800 border-t border-gray-100 dark:border-gray-700"></div>
            </section>
        </main>
    </div>

    <script src="common.js"></script>
    <script>
        // --- 1. ÁÉ≠Èó®Â∏ÅÁßçÊï∞ÊçÆ (Â∏¶ Logo) ---
        const popularCoins = [
            {s:'BTC',n:'Bitcoin'}, {s:'ETH',n:'Ethereum'}, {s:'BNB',n:'Binance Coin'}, {s:'SOL',n:'Solana'}, {s:'XRP',n:'Ripple'},
            {s:'DOGE',n:'Dogecoin'}, {s:'ADA',n:'Cardano'}, {s:'AVAX',n:'Avalanche'}, {s:'TRX',n:'Tron'}, {s:'LINK',n:'Chainlink'},
            {s:'PEPE',n:'Pepe'}, {s:'WIF',n:'dogwifhat'}, {s:'BONK',n:'Bonk'}, {s:'SHIB',n:'Shiba Inu'},
            {s:'DOT',n:'Polkadot'}, {s:'MATIC',n:'Polygon'}, {s:'LTC',n:'Litecoin'}, {s:'UNI',n:'Uniswap'},
            {s:'SUI',n:'Sui'}, {s:'APT',n:'Aptos'}, {s:'ARB',n:'Arbitrum'}, {s:'OP',n:'Optimism'}
        ];

        function getIconUrl(symbol) {
            return `https://lcw.nyc3.cdn.digitaloceanspaces.com/production/currencies/64/${symbol.toLowerCase()}.png`;
        }

        // --- 2. ‰∏ãÊãâËèúÂçïÈÄªËæë ---
        const coinInput = document.getElementById('coinSymbol');
        const coinDropdown = document.getElementById('coinDropdown');

        function renderDropdown(filterText = '') {
            coinDropdown.innerHTML = '';
            const text = filterText.toUpperCase();
            const filtered = popularCoins.filter(c => c.s.includes(text) || c.n.toUpperCase().includes(text));

            // Â¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÔºåÊòæÁ§∫Áî®Êà∑ËæìÂÖ•ÁöÑ
            if (filtered.length === 0 && text.length > 0) {
                 const div = document.createElement('div');
                 div.className = 'dropdown-item';
                 div.innerHTML = `<div class="avatar-fallback bg-gray-400">${text[0]}</div><div><div class="font-bold">${text}</div><div class="text-xs opacity-60">Manual Input</div></div>`;
                 div.onclick = () => selectCoin(text);
                 coinDropdown.appendChild(div);
            } else {
                // ÊòæÁ§∫ÂåπÈÖçÂàóË°®
                filtered.forEach(coin => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.innerHTML = `
                        <img src="${getIconUrl(coin.s)}" class="coin-icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <div class="avatar-fallback" style="display:none;">${coin.s[0]}</div>
                        <div><div class="font-bold">${coin.s}</div><div class="text-xs opacity-60">${coin.n}</div></div>
                    `;
                    div.onclick = () => selectCoin(coin.s);
                    coinDropdown.appendChild(div);
                });
            }
            if(filterText || filtered.length > 0) coinDropdown.style.display = 'block';
        }

        function selectCoin(symbol) {
            coinInput.value = symbol;
            coinDropdown.style.display = 'none';
            document.getElementById('err-coin').classList.add('hidden');
        }

        // ÁªëÂÆöÊêúÁ¥¢‰∫ã‰ª∂
        coinInput.addEventListener('input', (e) => renderDropdown(e.target.value));
        coinInput.addEventListener('focus', () => renderDropdown(coinInput.value));
        // ÁÇπÂáªÂ§ñÈÉ®ÈöêËóè
        document.addEventListener('click', (e) => {
            if (!coinInput.contains(e.target) && !coinDropdown.contains(e.target)) {
                coinDropdown.style.display = 'none';
            }
        });

        // --- 3. ÂÖ®Â±ÄÂèòÈáè‰∏éÂàùÂßãÂåñ ---
        window.currentRecords = [];
        window.myChart = null;
        window.currentPage = 1;
        const itemsPerPage = 10;

        window.pageInit = function() {
            // ËÆæÁΩÆÊó•ÊúüÈôêÂà∂ÔºöÁªìÊùüÊó∂Èó¥ÊúÄÂ§ß‰∏∫‰ªäÂ§©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('endDate').max = today;
            document.getElementById('endDate').value = today;
            
            // ÈªòËÆ§ÂºÄÂßãÊó∂Èó¥Ôºö‰∏ÄÂπ¥Ââç
            const lastYear = new Date(new Date().setFullYear(new Date().getFullYear() - 1)).toISOString().split('T')[0];
            document.getElementById('startDate').max = today;
            document.getElementById('startDate').value = lastYear;
            
            // ÁªëÂÆöÊåâÈíÆ
            document.getElementById('calcBtn').onclick = calculateDCA;
            document.getElementById('resetBtn').onclick = resetForm;
            document.getElementById('downloadBtn').onclick = downloadCSV;
        };

        window.refreshData = function() {
            if(!document.getElementById('resultSection').classList.contains('hidden')) {
                renderResults(); 
            }
        };

        // --- 4. Ê†∏ÂøÉËÆ°ÁÆóÈÄªËæë (Â∏¶Êô∫ËÉΩÊï∞ÊçÆÊäìÂèñ) ---
        async function calculateDCA() {
            const btn = document.getElementById('calcBtn');
            const originalText = btn.innerHTML;
            const msgBox = document.getElementById('dateFixMsg');
            msgBox.classList.add('hidden'); // ÈöêËóèÊóßÊèêÁ§∫

            // 1. ÂøÖÂ°´Ê†°È™å
            let hasError = false;
            ['coinSymbol', 'investAmount', 'startDate', 'endDate'].forEach(id => {
                const el = document.getElementById(id);
                const err = document.getElementById('err-' + (id==='coinSymbol'?'coin':id==='investAmount'?'amount':id==='startDate'?'start':'end'));
                if(!el.value) { err.classList.remove('hidden'); hasError = true; } 
                else { err.classList.add('hidden'); }
            });
            if(hasError) return;

            btn.innerHTML = '<span class="spinner"></span> Loading...';
            btn.disabled = true;

            try {
                const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
                const amount = parseFloat(document.getElementById('investAmount').value);
                const freq = parseInt(document.getElementById('frequency').value);
                let startStr = document.getElementById('startDate').value;
                const endStr = document.getElementById('endDate').value;

                let startTs = Math.floor(new Date(startStr).getTime() / 1000);
                const endTs = Math.floor(new Date(endStr).getTime() / 1000);
                
                // 2. Êô∫ËÉΩÊäìÂèñÊï∞ÊçÆ (‰∏ÄÊ¨°ÊÄßÊäìÂèñË∂≥Â§üÂ§öÁöÑÂéÜÂè≤)
                // ËøôÈáåÊàë‰ª¨ÊäìÂèñÂà∞Áî®Êà∑ÈÄâÊã©ÁöÑÁªìÊùüÊó∂Èó¥‰∏∫Ê≠¢ÁöÑ2000Êù°Êï∞ÊçÆ
                const url = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=${coinSymbol}&tsym=USDT&limit=2000&toTs=${endTs}`;
                const res = await fetch(url);
                const json = await res.json();
                
                if (json.Response === 'Error') throw new Error(json.Message);

                const prices = json.Data.Data; // ‰ª∑Ê†ºÊï∞ÁªÑ [{time, close}, ...]
                
                // 3. Êô∫ËÉΩÊó•Êúü‰øÆÊ≠£ÈÄªËæë
                // Â¶ÇÊûúAPIËøîÂõûÁöÑÊúÄÊó©Êï∞ÊçÆÊØîÁî®Êà∑ÈÄâÁöÑÂºÄÂßãÊó∂Èó¥ËøòÊôöÔºåËØ¥ÊòéÁî®Êà∑ÈÄâÂ§™Êó©‰∫Ü
                if (prices.length > 0) {
                    const firstApiTime = prices[0].time;
                    if (startTs < firstApiTime) {
                        const newDate = new Date(firstApiTime * 1000).toISOString().split('T')[0];
                        // ‰øÆÊ≠£ StartTs Âíå ËæìÂÖ•Ê°Ü
                        startTs = firstApiTime;
                        document.getElementById('startDate').value = newDate;
                        // ÊòæÁ§∫ÊèêÁ§∫
                        const tFix = currentLang === 'zh' ? 
                            `Â∑≤Ëá™Âä®‰øÆÊ≠£Ôºö${coinSymbol} ÁöÑÊúÄÊó©Êï∞ÊçÆÂßã‰∫é ${newDate}ÔºåËÆ°ÁÆóÂ∞Ü‰ªéËØ•Êó•ÊúüÂºÄÂßã„ÄÇ` : 
                            `Auto-corrected: ${coinSymbol} data starts from ${newDate}. Calculation adjusted.`;
                        document.getElementById('dateFixText').innerText = tFix;
                        msgBox.classList.remove('hidden');
                    }
                }

                const relevantData = prices.filter(p => p.time >= startTs);
                if (relevantData.length === 0) throw new Error("No Data in this range");

                // 4. ÂÆöÊäïÂõûÊµãËÆ°ÁÆó
                window.currentRecords = [];
                let totalInvestedUSD = 0;
                let totalCoins = 0;
                let nextBuyTs = startTs;

                for (let day of relevantData) {
                    if (day.time >= nextBuyTs) {
                        if(day.close > 0) {
                            const coins = amount / day.close;
                            totalCoins += coins;
                            totalInvestedUSD += amount;
                            
                            window.currentRecords.push({
                                date: new Date(day.time * 1000).toLocaleDateString(),
                                invest: amount,
                                price: day.close,
                                coins: coins,
                                totalInv: totalInvestedUSD,
                                totalCoins: totalCoins,
                                avgPrice: totalInvestedUSD / totalCoins,
                                ts: day.time
                            });
                        }
                        nextBuyTs += freq * 86400;
                    }
                }
                renderResults();

            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function renderResults() {
            if(window.currentRecords.length === 0) return;
            const last = window.currentRecords[window.currentRecords.length-1];
            const coinSymbol = document.getElementById('coinSymbol').value.toUpperCase();
            
            const finalValueUSD = last.totalCoins * last.price;
            const profitUSD = finalValueUSD - last.totalInv;

            document.getElementById('totalCoins').innerText = last.totalCoins.toFixed(4) + " " + coinSymbol;
            document.getElementById('totalCount').innerText = window.currentRecords.length;
            document.getElementById('totalInvested').innerText = formatMoney(last.totalInv);
            document.getElementById('currentValue').innerText = formatMoney(finalValueUSD);
            document.getElementById('totalProfit').innerText = formatMoney(profitUSD);
            document.getElementById('totalProfit').className = profitUSD >= 0 ? "text-xl md:text-3xl font-bold text-green-600" : "text-xl md:text-3xl font-bold text-red-600";
            document.getElementById('avgPrice').innerText = formatMoney(last.avgPrice);

            document.getElementById('resultSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');

            renderChart();
            window.currentPage = 1;
            renderTable();
        }

        function renderChart() {
            const ctx = document.getElementById('dcaChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            
            const curr = localStorage.getItem('currency') || 'USD';
            const t = (k) => window.getTrans ? window.getTrans(k) : k;

            const labels = window.currentRecords.map(r => r.date);
            const mktPrices = window.currentRecords.map(r => r.price);
            const avgPrices = window.currentRecords.map(r => r.avgPrice);
            const quantities = window.currentRecords.map(r => r.coins);

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: t('chart_qty'), data: quantities, type: 'bar', backgroundColor: 'rgba(59, 130, 246, 0.5)', yAxisID: 'y1', order: 2 },
                        { label: t('chart_avg') + ` (${curr})`, data: avgPrices, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 0, yAxisID: 'y', order: 1 },
                        { label: t('chart_mkt') + ` (${curr})`, data: mktPrices, borderColor: '#f59e0b', borderDash: [5, 5], pointRadius: 0, tension: 0.4, yAxisID: 'y', order: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: function(c) { 
                        return c.dataset.yAxisID === 'y1' ? c.dataset.label + ': ' + c.parsed.y : c.dataset.label + ': ' + formatMoney(c.parsed.y);
                    }}}},
                    scales: {
                        x: { display: false },
                        y: { position: 'right', grid: { color: document.body.classList.contains('dark-mode') ? '#334155' : '#f1f5f9' } },
                        y1: { position: 'left', display: true, grid: { display: false } }
                    }
                }
            });
        }

        function renderTable() {
            const tbody = document.getElementById('recordTableBody');
            tbody.innerHTML = '';
            const reversed = [...window.currentRecords].reverse();
            const start = (window.currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            
            reversed.slice(start, end).forEach(r => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 dark:hover:bg-slate-700 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3">${r.date}</td>
                    <td class="px-4 py-3">${formatMoney(r.invest)}</td>
                    <td class="px-4 py-3">${formatMoney(r.price)}</td>
                    <td class="px-4 py-3">${r.coins.toFixed(6)}</td>
                    <td class="px-4 py-3">${formatMoney(r.totalInv)}</td>
                    <td class="px-4 py-3">${r.totalCoins.toFixed(4)}</td>
                    <td class="px-4 py-3 text-blue-600 font-medium">${formatMoney(r.avgPrice)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            const totalPages = Math.ceil(reversed.length / itemsPerPage);
            const container = document.getElementById('paginationContainer');
            container.innerHTML = `
                <button ${window.currentPage===1?'disabled':''} onclick="window.currentPage--;renderTable()" class="px-3 py-1 bg-white dark:bg-slate-700 border rounded disabled:opacity-50"><</button>
                <span class="px-3 py-1 text-sm">Page ${window.currentPage} / ${totalPages}</span>
                <button ${window.currentPage===totalPages?'disabled':''} onclick="window.currentPage++;renderTable()" class="px-3 py-1 bg-white dark:bg-slate-700 border rounded disabled:opacity-50">></button>
            `;
        }

        function downloadCSV() {
            if (window.currentRecords.length === 0) return;
            const symbol = document.getElementById('coinSymbol').value;
            let csv = "Date,Invest,Price,Coins,TotalInv,TotalCoins,AvgPrice\n";
            window.currentRecords.forEach(r => {
                csv += `${r.date},${r.invest},${r.price},${r.coins},${r.totalInv},${r.totalCoins},${r.avgPrice}\n`;
            });
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = `DCA_${symbol}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetForm() {
            document.getElementById('coinSymbol').value = "";
            document.getElementById('investAmount').value = "100";
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('tableSection').classList.add('hidden');
            document.querySelectorAll('[id^="err-"]').forEach(e => e.classList.add('hidden'));
        }
    </script>
</body>
</html>
