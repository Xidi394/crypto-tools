<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Backtest - Crypto Tools</title>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #ffffff; --text: #2c3e50; --accent: #3498db; }
        body.dark-mode { --bg: #121212; --card-bg: #1e1e1e; --text: #ecf0f1; --accent: #5dade2; }
        body { font-family: -apple-system, sans-serif; padding: 15px; max-width: 640px; margin: 0 auto; background-color: var(--bg); color: var(--text); transition: 0.3s; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        input, select, button { width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; background: var(--bg); color: var(--text); box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .res-box { background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px; text-align: center; }
        .res-val { font-size: 20px; font-weight: bold; margin-top: 5px; display: block; word-break: break-all; }
        .green { color: #2ecc71; } .red { color: #e74c3c; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="margin-top:0;">ğŸ“‰ å®šæŠ•å›æµ‹ (DCA)</h2>
        <p style="font-size:12px; opacity:0.7;">æ•°æ®æº: CryptoCompare</p>

        <label>å¸ç§ (Symbol)</label>
        <input type="text" id="coinSymbol" value="BTC" placeholder="BTC, ETH, SOL...">

        <label>æ¯æ¬¡å®šæŠ•é‡‘é¢ (USDT)</label>
        <input type="number" id="investAmount" value="100">

        <label>å¼€å§‹æ—¥æœŸ</label>
        <input type="date" id="startDate" value="2024-01-01">

        <label>å®šæŠ•é¢‘ç‡</label>
        <select id="frequency">
            <option value="1">æ¯å¤© (Daily)</option>
            <option value="7" selected>æ¯å‘¨ (Weekly)</option>
            <option value="30">æ¯æœˆ (Monthly)</option>
        </select>

        <button onclick="calculateDCA()" id="calcBtn">å¼€å§‹å›æµ‹</button>
    </div>

    <div id="resultSection" class="card" style="display:none;">
        <h3 style="margin-top:0;">å›æµ‹ç»“æœ</h3>
        <div class="result-grid">
            <div class="res-box">
                <span style="font-size:12px;">æ€»æŠ•å…¥æœ¬é‡‘</span>
                <span id="totalInvested" class="res-val">--</span>
            </div>
            <div class="res-box">
                <span style="font-size:12px;">å½“å‰èµ„äº§ä»·å€¼</span>
                <span id="currentValue" class="res-val">--</span>
            </div>
            <div class="res-box">
                <span style="font-size:12px;">æŒä»“æ•°é‡</span>
                <span id="totalCoins" class="res-val">--</span>
            </div>
            <div class="res-box">
                <span style="font-size:12px;">æ”¶ç›Šç‡ (ROI)</span>
                <span id="roi" class="res-val">--</span>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // é¡µé¢åˆå§‹åŒ–æ—¶ï¼Œcommon.js ä¼šè°ƒç”¨è¿™ä¸ª
        window.pageInit = function() {
            // è®¾ç½®é»˜è®¤å¼€å§‹æ—¥æœŸä¸ºä¸€å¹´å‰
            const today = new Date();
            const lastYear = new Date(today.setFullYear(today.getFullYear() - 1));
            document.getElementById('startDate').value = lastYear.toISOString().split('T')[0];
        };

        // å½“ç”¨æˆ·åˆ‡æ¢è´§å¸æ—¶ï¼Œé‡æ–°è®¡ç®—ç»“æœ
        window.refreshData = function() {
            const resultDisplay = document.getElementById('resultSection').style.display;
            if (resultDisplay !== 'none') {
                calculateDCA(); // å¦‚æœå·²ç»æœ‰ç»“æœï¼Œé‡æ–°è®¡ç®—ä»¥åˆ·æ–°è´§å¸ç¬¦å·
            }
        };

        async function calculateDCA() {
            const btn = document.getElementById('calcBtn');
            const originalText = btn.innerText;
            btn.innerText = "è®¡ç®—ä¸­...";
            btn.disabled = true;

            try {
                // 1. è·å–ç”¨æˆ·è¾“å…¥
                const symbol = document.getElementById('coinSymbol').value.toUpperCase();
                const amount = parseFloat(document.getElementById('investAmount').value);
                const freq = parseInt(document.getElementById('frequency').value);
                const startDateStr = document.getElementById('startDate').value;
                
                // 2. è½¬æ¢æ—¶é—´æˆ³
                const startTs = Math.floor(new Date(startDateStr).getTime() / 1000);
                const endTs = Math.floor(new Date().getTime() / 1000); // æˆªæ­¢åˆ°ä»Šå¤©

                // 3. è·å–å†å²æ•°æ® (ä½¿ç”¨ CryptoCompare)
                // æ³¨æ„ï¼šè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œç®€å•è·å–æœ€è¿‘ 2000 å¤©çš„æ•°æ®
                const url = `https://min-api.cryptocompare.com/data/v2/histoday?fsym=${symbol}&tsym=USDT&limit=2000`;
                const res = await fetch(url);
                const json = await res.json();

                if (json.Response === 'Error') throw new Error(json.Message);

                const prices = json.Data.Data; // [{time:..., close:...}]
                
                // 4. å¼€å§‹å®šæŠ•é€»è¾‘
                let totalCoins = 0;
                let totalInvestedUSD = 0;
                let nextBuyTs = startTs;

                // è¿‡æ»¤å‡ºå¼€å§‹æ—¥æœŸä¹‹åçš„æ•°æ®
                const relevantData = prices.filter(p => p.time >= startTs);

                if (relevantData.length === 0) throw new Error("æ‰€é€‰æ—¥æœŸå¤ªæ—©æˆ–æ— æ•°æ®");

                // éå†æ¯ä¸€å¤©çš„æ•°æ®
                for (let dayData of relevantData) {
                    // å¦‚æœåˆ°äº†å®šæŠ•æ—¥ (ç®€å•æ¨¡æ‹Ÿ: æ—¶é—´æˆ³ >= ä¸‹æ¬¡ä¹°å…¥æ—¶é—´)
                    if (dayData.time >= nextBuyTs) {
                        const price = dayData.close;
                        if (price > 0) {
                            const coins = amount / price;
                            totalCoins += coins;
                            totalInvestedUSD += amount;
                        }
                        // æ›´æ–°ä¸‹æ¬¡ä¹°å…¥æ—¶é—´ (+ 7å¤© æˆ– +1å¤©)
                        nextBuyTs += freq * 86400; 
                    }
                }

                // 5. è®¡ç®—ç»“æœ
                const currentPrice = relevantData[relevantData.length - 1].close;
                const finalValueUSD = totalCoins * currentPrice;
                const profitUSD = finalValueUSD - totalInvestedUSD;
                const roi = (profitUSD / totalInvestedUSD) * 100;

                // 6. æ˜¾ç¤ºç»“æœ (ä½¿ç”¨ common.js çš„ formatMoney è‡ªåŠ¨è½¬æ±‡ç‡)
                document.getElementById('resultSection').style.display = 'block';
                
                document.getElementById('totalInvested').innerText = formatMoney(totalInvestedUSD);
                document.getElementById('currentValue').innerText = formatMoney(finalValueUSD);
                document.getElementById('totalCoins').innerText = totalCoins.toFixed(4) + " " + symbol;
                
                const roiEl = document.getElementById('roi');
                roiEl.innerText = roi.toFixed(2) + "%";
                roiEl.className = roi >= 0 ? "res-val green" : "res-val red";

            } catch (err) {
                alert("è®¡ç®—å¤±è´¥: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
